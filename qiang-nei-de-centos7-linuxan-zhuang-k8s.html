<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>墙内的Centos7 Linux安装K8S</title>

    <link rel="stylesheet" href="https://gccpacman.github.io/theme/css/normalize.css" />
    <link rel="stylesheet" href="https://gccpacman.github.io/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="https://gccpacman.github.io/theme/css/style.css" />
    <link rel="stylesheet" href="https://gccpacman.github.io/theme/css/pygments.css" />	
    <script src="https://gccpacman.github.io/theme/js/modernizr.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-146579327-1"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-146579327-1');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8793956340609221",
        enable_page_level_ads: true
    });
    </script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="/">Pacman News</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
<article>
    <header>
        <h3 class="article-title"><a href="https://gccpacman.github.io/qiang-nei-de-centos7-linuxan-zhuang-k8s.html" rel="bookmark"
        title="Permalink to 墙内的Centos7 Linux安装K8S">墙内的Centos7 Linux安装K8S</a></h3>
    </header>

<h6 class="subheader" title="2019-05-07T11:13:00+08:00">周二 07 五月 2019
</h6>


    <ol>
<li>
<p>安装基础构建依赖</p>
<div class="highlight"><pre><span></span>$ yum -y install yum-utils device-mapper-persistent-data lvm2
</pre></div>


</li>
<li>
<p>安装Docker</p>
<div class="highlight"><pre><span></span>$ yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
$ yum -y install docker-ce
$ systemctl start docker <span class="o">&amp;&amp;</span> systemctl <span class="nb">enable</span> docker 
$ docker images   <span class="c1"># 确定docker命令正常</span>
</pre></div>


</li>
<li>
<p>安装Kubernetes</p>
<p>3.1 安装kubeadm, kubelet, kubectl</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">vim</span><span class="w"> </span><span class="n">kubernetes</span><span class="p">.</span><span class="n">repo</span><span class="w"></span>

<span class="o">[</span><span class="n">kubernetes</span><span class="o">]</span><span class="w"></span>
<span class="n">name</span><span class="o">=</span><span class="n">Kubernetes</span><span class="w"></span>
<span class="n">baseurl</span><span class="o">=</span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">mirrors</span><span class="p">.</span><span class="n">aliyun</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">yum</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">el7</span><span class="o">-</span><span class="n">x86_64</span><span class="w"></span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">1</span><span class="w"></span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">0</span><span class="w"></span>

<span class="err">$</span><span class="w"> </span><span class="n">yum</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">kubelet</span><span class="w"> </span><span class="n">kubeadm</span><span class="w"> </span><span class="n">kubectl</span><span class="w"> </span><span class="n">kubernetes</span><span class="o">-</span><span class="n">cni</span><span class="w"></span>
<span class="err">$</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">kubelet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">kubelet</span><span class="w"></span>
</pre></div>


<p>3.2 pull下来kubernetes要要到的镜像，因为k8s.gcr.io这个域名被墙，需要从阿里云pull下来然后重新打tag，参考文档里的几篇版本都对不上，首先可以通过这个命令<code>列出</code>确定需要pull的镜像和版本：</p>
<div class="highlight"><pre><span></span>$ kubeadm config images list
</pre></div>


<p>3.3 根据上一步列出的镜像和版本号，参考<code>https://github.com/cookcodeblog/k8s-deploy</code>的目录<code>kubeadm_v1.13.0/04_pull_kubernetes_images_from_aliyun.sh</code>编写一个脚本，注意替换成你需要的版本，然后执行。</p>
<p>3.4 关闭swap，注释掉<code>/etc/fstab</code>里的swap一行，重启后生效，并关闭selinux</p>
<div class="highlight"><pre><span></span>$ swapoff -a
$ setenforce <span class="m">0</span>
$ sed -i <span class="s1">&#39;s/SELINUX=permissive/SELINUX=disabled/&#39;</span> /etc/sysconfig/selinux
</pre></div>


<p>3.5 配置网络转发</p>
<div class="highlight"><pre><span></span>$ vim /etc/sysctl.d/k8s.conf

net.bridge.bridge-nf-call-ip6tables <span class="o">=</span> <span class="m">1</span>
net.bridge.bridge-nf-call-iptables <span class="o">=</span> <span class="m">1</span>
net.ipv4.conf.all.forwarding <span class="o">=</span> <span class="m">1</span>
vm.swappiness <span class="o">=</span> <span class="m">0</span>

$ sysctl --system  <span class="c1"># 确定配置生效</span>
</pre></div>


<p>3.6 初始化kubeadm，等待命令执行完成</p>
<div class="highlight"><pre><span></span>$ kubeadm init
</pre></div>


<p>3.7 配置kubectl</p>
<div class="highlight"><pre><span></span>$ mkdir -p <span class="nv">$HOME</span>/.kube
$ cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
$ chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
$ kubectl get nodes <span class="c1"># 确认kubectl配置成功</span>
</pre></div>


</li>
<li>
<p>在Kubenetes里安装Flannel网络</p>
<p>4.1 pull下Flannel镜像过程因为防火墙的原因依旧类似3.3操作，参考<code>https://github.com/cookcodeblog/k8s-deploy/tree/master/kubeadm_v1.13.0</code>里的<code>kubeadm_v1.13.0/pull_flannel_images_from_aliyun.sh</code>写一个脚本文件，这次的版本就用<code>v0.11.0</code>就好，便写完成执行脚本</p>
<p>4.2 安装Flannel网络</p>
<div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="p">.</span><span class="n">yml</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="p">.</span><span class="n">githubusercontent</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">coreos</span><span class="o">/</span><span class="n">flannel</span><span class="o">/</span><span class="n">a70459be0084506e4ec919aa1c114638878db11b</span><span class="o">/</span><span class="n">Documentation</span><span class="o">/</span><span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="p">.</span><span class="n">yml</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">kube</span><span class="o">-</span><span class="n">flannel</span><span class="p">.</span><span class="n">yml</span>

<span class="o">#</span> <span class="err">过几十秒确认是否启动成功</span>
<span class="n">kubectl</span> <span class="k">get</span> <span class="n">pods</span> <span class="c1">--all-namespaces</span>
<span class="n">kubectl</span> <span class="k">get</span> <span class="n">cs</span>
</pre></div>


</li>
</ol>
<p>通过这四个步骤的成功执行，一个单机版本的Kubernetes已经安装完毕，接下去还可以做以下事情继续折腾，等之后有时间再折腾：
1. 添加一个worker节点加入到K8S集群
2. 可以根据参考文档，安装一个<code>K8S Dashboard</code>等或者部署应用
3. 尝试在自己实现Ingress的负载均衡</p>
<p>参考：</p>
<p>https://juejin.im/post/5c36fd906fb9a049f8197c9b</p>
<p>https://www.howtoforge.com/tutorial/centos-kubernetes-docker-cluster/</p>
<p>https://github.com/cookcodeblog/k8s-deploy</p>
<p class="subheader">分类: <a href="https://gccpacman.github.io/category/kubernetes.html">Kubernetes</a>

    标签: 
    <a href="https://gccpacman.github.io/tag/kubernetes.html">kubernetes </a>
    <a href="https://gccpacman.github.io/tag/centos.html">centos </a>
    <a href="https://gccpacman.github.io/tag/docker.html">docker </a>
</p>




</article>
    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">

		
        <h5 class="sidebar-title">分类</h5>
        <ul class="side-nav">
            <li><a href="https://gccpacman.github.io/category/kubernetes.html">Kubernetes</a></li>
            <li><a href="https://gccpacman.github.io/category/linux.html">Linux</a></li>
            <li><a href="https://gccpacman.github.io/category/nodejs.html">Nodejs</a></li>
            <li><a href="https://gccpacman.github.io/category/python.html">python</a></li>
            <li><a href="https://gccpacman.github.io/category/tmux.html">Tmux</a></li>
            <li><a href="https://gccpacman.github.io/category/vim.html">Vim</a></li>
            <li><a href="https://gccpacman.github.io/category/windows.html">Windows</a></li>
   
        </ul>
		
        <h5 class="sidebar-title">我的社交账号</h5>
        <ul class="side-nav">
            <li><a href="https://github.com/gccpacman">Github: @gccpacman</a></li>
            <li><a href="https://stackoverflow.com/users/4124310/evan-hu?tab=profile">StackOverflow: @evan-hu</a></li>
        </ul>

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <!-- ad1 -->
        <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-8793956340609221"
            data-ad-slot="6268981024"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>Pacman News by r341h</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>